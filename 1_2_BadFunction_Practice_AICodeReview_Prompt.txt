How can I improve this function? Show me before/after comparison.